#!/bin/sh
help ()
{
    cat << HELP_EOF

Usage:
    jmax-make-install  tar-file  [installation-directory]

Installs jMax from a compressed tar file in the directory of
your choice.

Arguments:
 tar-file                     (mandatory)
    the tar file containing the files to install
 installation-directory       (defaults to /usr/local)
    the directory in which the installation must be made.
    NOTE: all the subdirectories installed will be in
    <installation-directory>/max

HELP_EOF
}

confirm ()
{
echo $*
read R
if [ $R != "yes" -a $R != "y" ]
then
    echo "OK. Nothing changed. Bye."
    exit 2
fi
}


### Start processing

if [ $# -lt 1 ]
then
    help
    exit 2
elif [ $# -lt 2 ]
then
    INSTALL_DIR=/usr/local
else
    INSTALL_DIR=$2
fi

TARFILE=$1


if [ \! -f $TARFILE ]
then
    echo $TARFILE not found >&2
    exit 2
fi

# As this script is supposed to be run as root, some confirmation is usefull
confirm "OK to install jMax in ${INSTALL_DIR}/max ? "

if [ \! -d ${INSTALL_DIR} ]
then
    echo "Creating directory ${INSTALL_DIR}"
    mkdir ${INSTALL_DIR}
    chmod a+rx ${INSTALL_DIR}
fi
if [ \! -d ${INSTALL_DIR}/max ]
then
    echo "Creating directory ${INSTALL_DIR}/max"
    mkdir ${INSTALL_DIR}/max
    chmod a+rx ${INSTALL_DIR}/max
fi


# Remove everything starting from installation directory
confirm "Remove ${INSTALL_DIR}/max/* ? "

echo Removing ${INSTALL_DIR}/max/*
/bin/rm -rf ${INSTALL_DIR}/max/*


# Detar the tar file
gzip -cd $TARFILE | ( cd ${INSTALL_DIR}/max/.. && tar xvf - )


# Try to change mode to setuid for the fts executables
confirm "Change mode of executables to allow setuid ? "
for fts in `find ${INSTALL_DIR}/max -name fts -type f -perm -a+x`
do
    echo "Copying $fts to $fts.setuid"
    cp $fts $fts.setuid
    echo "Changing mode of $fts.setuid to allow setpriority()"
    chown root $fts.setuid
    chmod u+s $fts.setuid
done

