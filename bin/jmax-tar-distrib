#!/bin/sh
help ()
{
    cat >&2 << HELP_EOF

Usage:
    jmax-tar-distrib -type <type> -arch <arch>

Creates the tar file of jMax distribution for architecture <arch> and type <type>.

Options:
  -type <type>                 (mandatory)
    defines the type of the release (free, forum, ...)
  -arch <arch>                 (mandatory)
    defines the architecture of the release (origin, linuxpc, ...)

HELP_EOF
}

OPT="none"
ARCH="none"
TYPE="none"
TAR="tar"
TARFILE="none"
ROOTDIR="none"

for ARG in $@
do
    if [ $OPT = "none" ]
    then
	case $ARG in
	\-arch | \-tar | \-type )
	    OPT=$ARG ;;
	*)
	    help ;
	    exit 2 ;;
	esac
    else
	case $OPT in
	\-arch )
	    ARCH=$ARG ;;
	\-type )
	    TYPE=$ARG ;;
	\-tar )
	    TAR=$ARG ;;
	esac
	OPT="none";
    fi
done

# Check that we have what we need
if [ $ARCH = "none" ]
then
    help
    exit 2
fi

if [ $TYPE = "none" ]
then
    help
    exit 2
fi

if [ \! -r VERSION ]
then
    echo "Cannot find file VERSION (probably you're not in the correct directory ...)"
    exit 1
fi

#if $TAR --version | grep -s GNU >/dev/null 
#then
#    echo > /dev/null
#else
#    echo $TAR is not GNU tar. Cannot use it!
#    exit 2
#fi

#
MAJOR=`awk '$1=="MAJOR" { print $2; }' VERSION`
MINOR=`awk '$1=="MINOR" { print $2; }' VERSION`
PATCH_LEVEL=`awk '$1=="PATCH_LEVEL" { print $2; }' VERSION`

VERSION=$MAJOR.$MINOR.$PATCH_LEVEL

# 
DEST_DIR=/tmp/max-${VERSION}
if [ -d ${DEST_DIR} ]
then
    /bin/rm -rf ${DEST_DIR}
fi
mkdir ${DEST_DIR}
chmod 755 ${DEST_DIR}

# args: ARCH TYPE DIR DEST
copy_files ()
{
    if [ \! -f $3/distrib ] ;  then echo "File $3/distrib missing" >&2 ; exit 1 ; fi

    {
	read TYPE_F ARCH_F NAME OTHERS
	#echo read $TYPE_F $ARCH_F $NAME $OTHERS "<" $3/distrib

	while [ $ARCH_F ] 
	do
	    if [ \( $ARCH_F = $1 -o $ARCH_F = "all" \) -a \( $TYPE_F = $2 -o $TYPE_F = "all" \) ]
	    then
		if [ -f "$3/$NAME" ]
		then
		    D=`dirname $4/$NAME`
		    if [ ! -d $D ] ; then mkdir -p $D ; chmod 755 $D ; echo "Created $D" ; fi

		    cp $3/$NAME $4/$NAME

		    if ls -l $3/$NAME | awk '{ exit ( !(substr($1,4,1)=="x") ); }'
		    then
			chmod 755 $4/$NAME
		    else
			chmod 644 $4/$NAME
		    fi
		    echo Copyied $4/$NAME

		elif [ -d "$3/$NAME" ]
		then
		    mkdir -p $4/$NAME
		    chmod 755 $4/$NAME
		    echo Created $4/$NAME
		    copy_files $1 $2 $3/$NAME $4/$NAME
		else
		    echo "File or directory $3/$NAME not found" >&2
		    exit 2
		fi
	    fi
	    read TYPE_F ARCH_F NAME OTHERS
	    #echo read $TYPE_F $ARCH_F $NAME $OTHERS "<" $3/distrib
	done
    } < $3/distrib
}

echo Copying files
copy_files $ARCH $TYPE . ${DEST_DIR}

# Create the tar file
if [ ! -d /u/worksta/jmaxdev/releases/${TYPE}/${ARCH} ]
then
    mkdir -p /u/worksta/jmaxdev/releases/${TYPE}/${ARCH}
fi
TARFILE=/u/worksta/jmaxdev/releases/${TYPE}/${ARCH}/jmax.${TYPE}.${ARCH}.${VERSION}.tar.gz
echo "Creating tar file $TARFILE"
(cd /tmp ; tar cvf - max-${VERSION} ) | gzip -9 > $TARFILE
chmod 644 $TARFILE
