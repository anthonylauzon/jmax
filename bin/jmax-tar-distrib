#!/bin/sh
#
#  jMax
#  
#  Copyright (C) 1999 by IRCAM
#  All rights reserved.
#  
#  This program may be used and distributed under the terms of the 
#  accompanying LICENSE.
# 
#  This program is distributed WITHOUT ANY WARRANTY. See the LICENSE
#  for DISCLAIMER OF WARRANTY.
#  


# ***************************************************************************
# Constants
# ***************************************************************************
RELEASES_DIR=/u/worksta/jmaxdev/releases

# ***************************************************************************
# Functions
# ***************************************************************************

# ---------------------------------------------------------------------------
help ()
{
    cat >&2 << HELP_EOF

Usage:
    jmax-tar-distrib -type <type> -arch <arch> [-dest <file>] [-tmp <dir>]

Creates tar file of jMax distribution for architecture <arch> and type <type>.

Options:
  -type <type>                 (mandatory)
    create release type <type> (free, ircam, src, ...)
  -arch <arch>                 (mandatory)
    create release for architecture <arch> (sgi, linuxpc, ...)
  -dest <file>                 (optional)
    creates tar file <file>.
  -tmp <dir>                   (optional)
    use <dir> as temporary directory. Defaults to /tmp
  -quiet                       (optional)
    do not exit if a file is missing

HELP_EOF
}

# ---------------------------------------------------------------------------
decrypt_options ()
{
    OPT="none"
    ARCH="none"
    TYPE="none"
    DEST_FILE="none"
    TMP="/tmp"
    QUIET="false"

    for ARG in $@
    do
	if [ $OPT = "none" ]
	then
	    case $ARG in
	    \-arch | \-type | \-dest | \-tmp )
		OPT=$ARG ;;
	    \-quiet )
		QUIET="true" ;;
	    *)
		help ;
		exit 2 ;;
	    esac
	else
	    case $OPT in
	    \-arch )
		ARCH=$ARG ;;
	    \-type )
		TYPE=$ARG ;;
	    \-tmp )
		TMP=$ARG ;;
	    \-dest )
		DEST_FILE=$ARG ;;
	    esac
	    OPT="none";
	fi
    done
}

# ---------------------------------------------------------------------------
check_it ()
{
    if [ $ARCH = "none" ]
    then
	help
	exit 2
    fi

    if [ $TYPE = "none" ]
    then
	help
	exit 2
    fi

    if [ \! -r VERSION ]
    then
	echo "Cannot find file VERSION (probably you're not in the correct directory ...)"
	exit 1
    fi

}

# ---------------------------------------------------------------------------
compute_version_number ()
{
    MAJOR=`awk '$1=="MAJOR" { print $2; }' VERSION`
    MINOR=`awk '$1=="MINOR" { print $2; }' VERSION`
    PATCH_LEVEL=`awk '$1=="PATCH_LEVEL" { print $2; }' VERSION`

    VERSION=$MAJOR.$MINOR.$PATCH_LEVEL
}

# ---------------------------------------------------------------------------
create_dest_dir()
{
    DEST_DIR=${TMP}/$$/max-${VERSION}
    if [ -d ${DEST_DIR} ]
    then
	/bin/rm -rf ${DEST_DIR}
    fi
    mkdir -p ${DEST_DIR}
    chmod 755 ${DEST_DIR}
}

# ---------------------------------------------------------------------------
remove_dest_dir()
{
    /bin/rm -rf ${TMP}/$$
}


# ---------------------------------------------------------------------------
# args: STATUS
clean_exit()
{
	remove_dest_dir
	exit $1
}

# ---------------------------------------------------------------------------
# args: DIR
create_dir ()
{
    D=`echo $1 | sed 's+^\.\/++'`
    mkdir -p $DEST_DIR/$D

    i=$DEST_DIR
    for d in `echo $D | sed 's+\/+ +g'`
    do
	i="$i/$d"
	chmod 755 $i
    done
}

# ---------------------------------------------------------------------------
# args: RELATIVE_DIR PATTERN
copy_files()
{
    for F in `ls -d $2`
    do
	if [ -f $F ]
  	then

  	    DST=`echo $1/$F | sed 's+^\.\/++'`

  	    D=`dirname $DST`
  	    if [ ! -d $DEST_DIR/$D ]
  	    then
  		create_dir $D
  	    fi

  	    cp $F $DEST_DIR/$DST
  	    if ls -l $F | awk '{ exit(!(substr($1,4,1)=="x")); }'
  	    then
  		chmod 755 $DEST_DIR/$DST
  	    else
  		chmod 644 $DEST_DIR/$DST
  	    fi

  	elif [ -d $F ]
  	then

  	    create_dir $1/$F
  	    (cd $F ; select_files $1/$F )

  	else
  	    echo "File or directory $F not found" >&2

  	    if [ $QUIET = "false" ]
  	    then
  		clean_exit 1
  	    fi
  	fi
      done
}


# ---------------------------------------------------------------------------
# args: RELATIVE_DIR
select_files ()
{
    if [ \! -f distrib ]
    then
	echo "jmax-tar-distrib: File $1/distrib missing" >&2
	clean_exit 1
    fi

      {
  	echo "jmax-tar-distrib: Processing $1"

  	read TYPE_F ARCH_F PATTERN NEW_NAME

  	while [ $ARCH_F ] 
  	do
  	    if [ \( $ARCH_F = $ARCH -o $ARCH_F = "all" \) -a \( $TYPE_F = $TYPE -o $TYPE_F = "all" \) ]
  	    then
  		copy_files $1 "$PATTERN"
  	    fi

  	    read TYPE_F ARCH_F PATTERN NEW_NAME
  	done
      } < distrib

}

# ---------------------------------------------------------------------------
# Create the tar file
create_tar ()
{
    if [ $DEST_FILE != "none" ]
    then
	echo "(A) Creating tar file $DEST_FILE"
	(cd ${DEST_DIR}/.. ; tar cvf - max-${VERSION} ) | gzip -9 > $DEST_FILE
    else
	TARDIR=${RELEASES_DIR}/${VERSION}
	if [ ! -d ${TARDIR} ]
	then
	    mkdir -p ${TARDIR}
	fi
	if [ ! -w ${TARDIR} ]
	then
	    chmod u+w ${TARDIR}
	fi

	TARFILE=${TARDIR}/jmax.${TYPE}.${ARCH}.${VERSION}.tar.gz

	if [ ! -w ${TARFILE} ]
	then
	    chmod u+w ${TARFILE}
	fi

	echo "(B) Creating tar file $TARFILE"
	(cd ${DEST_DIR}/.. ; tar cvf - max-${VERSION} ) | gzip -9 > $TARFILE

	chmod 444 ${TARFILE}
	chmod 555 ${TARDIR}
    fi
}

# ***************************************************************************
# Beginning of script
# ***************************************************************************

decrypt_options $@

check_it

compute_version_number

create_dest_dir

select_files .

create_tar

clean_exit 0
