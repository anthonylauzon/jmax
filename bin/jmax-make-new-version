#!/bin/sh

# ***************************************************************************
# Constants
# ***************************************************************************

HOST_FOR_CVS=maelzel

# ***************************************************************************
# Functions
# ***************************************************************************
help ()
{
    cat >&2 << HELP_EOF

Usage:
    jmax-make-new-version -type [patch|minor|major] [-nomail]

Makes a new version of jMax:
  - increments the version number in file VERSION
  - generates new files for FTS and Java to know the new version number
  - send a mail to the development team to inform of the change

Options:
  -type patch|minor|major           (mandatory)
    defines which number will change in the new version number
  -nomail                           (optional)
    tells jmax-make-new-version not to send a mail after doing his job

HELP_EOF
}

# ---------------------------------------------------------------------------
inform ()
{
    echo "... $@"
}

# ---------------------------------------------------------------------------
decrypt_options ()
{
    OPT="none"
    TYPE="none"

    for ARG in $@
    do
	if [ $OPT = "none" ]
	then
	    case $ARG in
	    \-type )
		OPT=$ARG ;;
	    \-help | \-h | \-\? )
		help ;
		exit 2 ;;
	    *)
		help ;
		exit 2 ;;
	    esac
	else
	    case $OPT in
	    \-type )
		TYPE=$ARG ;;
	    esac
	    OPT="none";
	fi
    done
}

# ---------------------------------------------------------------------------
check_options ()
{
    case $TYPE in
    patch | minor | major )
	;;
    *)
	help ;
	exit 2 ;;
    esac

    if [ `hostname` != $HOST_FOR_CVS ]
    then
	echo "Incorrect host (log on $HOST_FOR_CVS to call this script, because CVS ...)"
	exit 1
    fi

    if [ \! -r VERSION ]
    then
	echo "Cannot find file VERSION (probably you're not in the correct directory ...)"
	exit 1
    fi
}

# ---------------------------------------------------------------------------
compute_new_version_number ()
{
    MAJOR=`awk '$1=="MAJOR" { print $2; }' VERSION`
    MINOR=`awk '$1=="MINOR" { print $2; }' VERSION`
    PATCH_LEVEL=`awk '$1=="PATCH_LEVEL" { print $2; }' VERSION`

    OLD_VERSION=$MAJOR.$MINOR.$PATCH_LEVEL

    case $TYPE in
    major )
	NEW_MAJOR=`echo $MAJOR + 1 | bc`
	NEW_MINOR=0
	NEW_PATCH_LEVEL=0 ;;
    minor )
	NEW_MAJOR=$MAJOR
	NEW_MINOR=`echo $MINOR + 1 | bc`
	NEW_PATCH_LEVEL=0 ;;
    patch )
	NEW_MAJOR=$MAJOR
	NEW_MINOR=$MINOR
	NEW_PATCH_LEVEL=`echo $PATCH_LEVEL + 1 | bc` ;;
    esac

    NEW_VERSION=$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH_LEVEL
}


# ---------------------------------------------------------------------------
generate_file ()
{
    inform Generating new file $2

    cat $1 > $2

    inform Commiting file $2
    ( cd `dirname $2` ; cvs commit -l -m "$CVS_MESSAGE" `basename $2`)
}

# ---------------------------------------------------------------------------
send_a_mail ()
{
    TEAM="dechelle@ircam.fr dececco@ircam.fr maggi@ircam.fr schnell@ircam.fr"
    inform Sending a mail to $TEAM
    echo "Don't forget to do 'cvs update'\n" | Mail -s "New jMax version is now $NEW_VERSION" $TEAM
}

# ***************************************************************************
# Beginning of script
# ***************************************************************************

decrypt_options $@

check_options

compute_new_version_number

CVS_MESSAGE="Automatic commit (version number changed to $NEW_VERSION)"

# ---------------------------------------------------------------------------
cat <<EOF >/tmp/$$
MAJOR        $NEW_MAJOR
MINOR        $NEW_MINOR
PATCH_LEVEL  $NEW_PATCH_LEVEL 
EOF
generate_file /tmp/$$ VERSION

# ---------------------------------------------------------------------------
cat <<EOF >/tmp/$$
<HTML>
<HEAD>
<TITLE> jMax release notes for version $NEW_VERSION </TITLE>
</HEAD>

<CENTER> <H1> jMax release notes for version $NEW_VERSION </H1> </CENTER>


<H2> Fixed bugs </H2>

The following bugs have been fixed:
<UL>
<LI> 
</UL>

For bugs reported via the bug report system
(<A HREF="http://www.ircam.fr/bugs">http://www.ircam.fr/bugs</A>, 
please refer to this page for information.


<H2> New features </H2>

<UL>
<LI> 
</UL>


<H2> Known bugs </H2>

<UL>
<LI> 
</UL>


<H2> Outstanding bugs and features </H2>

<UL>
<LI> 
</UL>

</HTML>
EOF
generate_file /tmp/$$ RELEASE_NOTES.html

# ---------------------------------------------------------------------------
cat <<EOF >/tmp/$$
/* DO NOT EDIT THIS FILE: it is generated automatically by the script ``jmax-make-new-version'' */

#define FTS_VERSION_STRING "jMax version $NEW_VERSION\n"

EOF
generate_file /tmp/$$ fts/src/sys/version.h

# ---------------------------------------------------------------------------
cat <<EOF >/tmp/$$
// DO NOT EDIT THIS FILE: it is generated automatically by the script ``jmax-make-new-version''

package ircam.jmax;

public class MaxVersion {
  public static String getMaxVersion()
  {
     return "jMax version $NEW_VERSION";
  } 
}
EOF
generate_file /tmp/$$ java/src/ircam/jmax/MaxVersion.java
# ---------------------------------------------------------------------------

send_a_mail

inform Done
